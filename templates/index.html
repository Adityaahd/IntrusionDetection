<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Intrusion Detection System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        .status-calibrating { background: var(--warning); }
        .status-active { background: var(--success); }
        .status-motion { 
            background: var(--danger); 
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--dark);
            flex: 1;
        }
        
        .calibration-progress {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--warning), var(--success));
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .events-log {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .event-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .event-motion {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.2);
        }
        
        .event-system {
            border-left-color: var(--warning);
        }
        
        .event-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            background: var(--danger);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            border-left: 5px solid #ff6b6b;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-success {
            background: var(--success);
            border-left-color: #51cf66;
        }
        
        .notification-warning {
            background: var(--warning);
            border-left-color: #ff922b;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-shield-alt"></i>
                IoT Intrusion Detection System
            </h1>
            <p>Real-time Arduino Monitoring</p>
        </div>
        
        <div class="dashboard">
            <!-- Connection Control Card -->
            <div class="card">
                <h3><i class="fas fa-plug"></i> Serial Connection</h3>
                <div id="connection-status">
                    <span class="status-indicator status-disconnected"></span>
                    <span id="status-text">Disconnected</span>
                </div>
                
                <!-- Calibration Progress -->
                <div class="calibration-progress" id="calibration-progress">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-hourglass-half"></i>
                        <strong>Sensor Calibration</strong>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progress-percent">0%</span>
                        <span id="progress-remaining">30s remaining</span>
                    </div>
                </div>
                
                <div class="controls">
                    <select id="port-select">
                        <option value="COM10">COM10 (Arduino)</option>
                        <option value="COM3">COM3</option>
                        <option value="COM4">COM4</option>
                    </select>
                    <button class="btn btn-success" onclick="connectSerial()" id="connect-btn">
                        <i class="fas fa-link"></i> Connect
                    </button>
                    <button class="btn btn-danger" onclick="disconnectSerial()" id="disconnect-btn" disabled>
                        <i class="fas fa-unlink"></i> Disconnect
                    </button>
                </div>
            </div>
            
            <!-- Sensor Status Card -->
            <div class="card">
                <h3><i class="fas fa-satellite-dish"></i> Sensor Status</h3>
                <div id="sensor-status">
                    <span class="status-indicator status-disconnected"></span>
                    <span id="sensor-status-text">Offline</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Events</div>
                        <div class="stat-value" id="total-events">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Today</div>
                        <div class="stat-value" id="today-events">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Motion Detection Card -->
            <div class="card">
                <h3><i class="fas fa-running"></i> Motion Detection</h3>
                <div id="motion-status">
                    <span class="status-indicator status-disconnected"></span>
                    <span id="motion-status-text">No Motion</span>
                </div>
                <div id="motion-duration" style="margin-top: 10px; font-size: 0.9rem;"></div>
            </div>
        </div>
        
        <!-- Events Log -->
        <div class="card">
            <h3><i class="fas fa-list"></i> Real-time Events Log</h3>
            <div class="events-log" id="events-log">
                <div class="event-item event-system">
                    <div class="event-time">System Ready</div>
                    <div>Click Connect to start monitoring Arduino</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div class="notification" id="notification">
        <strong id="notification-title">Motion Detected!</strong>
        <div id="notification-message">Intrusion alert</div>
    </div>

    <script>
        const socket = io();
        let isConnected = false;
        let notificationTimeout = null;
        let lastMotionTime = 0;
        const MOTION_COOLDOWN = 1000; // 1 second cooldown between motion alerts
        
        // Socket event handlers
        socket.on('connect', function() {
            console.log('✅ Connected to backend WebSocket');
            addEvent('system', 'Connected to monitoring server');
            updateStats();
        });
        
        socket.on('serial_status', function(data) {
            console.log('📡 Serial status:', data);
            updateConnectionStatus(data.status, data.port);
        });
        
        socket.on('serial_error', function(data) {
            console.error('❌ Serial error:', data.error);
            addEvent('system', `Connection error: ${data.error}`);
            updateConnectionStatus('error');
        });
        
        socket.on('sensor_status', function(data) {
            console.log('🔧 Sensor status:', data);
            updateSensorStatus(data.status);
        });
        
        socket.on('motion_status', function(data) {
            console.log('🚨 Motion status:', data);
            updateMotionStatus(data.status, data.duration);
            
            if (data.status === 'detected') {
                updateStats(); // Update stats immediately on motion
            }
        });
        
        socket.on('motion_alert', function(data) {
            console.log('🚨 Motion alert:', data);
            const now = Date.now();
            
            // Prevent multiple alerts within cooldown period
            if (now - lastMotionTime > MOTION_COOLDOWN) {
                showNotification('🚨 Motion Detected!', 'Intrusion alert triggered', 'danger');
                lastMotionTime = now;
                
                // Browser notification
                if (Notification.permission === 'granted') {
                    new Notification('🚨 Motion Detected!', {
                        body: 'Intrusion alert triggered - ' + new Date().toLocaleTimeString(),
                        icon: '/favicon.ico',
                        tag: 'motion-alert' // This allows replacing previous notifications
                    });
                }
            }
        });
        
        socket.on('calibration_progress', function(data) {
            console.log('⏳ Calibration progress:', data);
            updateCalibrationProgress(data);
        });
        
        socket.on('log_update', function(data) {
            console.log('📝 Log update:', data);
            addEvent(data.type, data.message, data.duration);
        });
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    addEvent('system', 'Browser notifications enabled');
                }
            });
        }
        
        // Connection functions
        function connectSerial() {
            const port = document.getElementById('port-select').value;
            const baudrate = 9600;
            
            console.log(`🔌 Connecting to ${port}...`);
            addEvent('system', `Attempting to connect to ${port}...`);
            
            document.getElementById('connect-btn').disabled = true;
            
            fetch('/api/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ port, baudrate })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    document.getElementById('connect-btn').disabled = false;
                }
            })
            .catch(error => {
                console.error('Connection error:', error);
                addEvent('system', `Connection failed: ${error}`);
                document.getElementById('connect-btn').disabled = false;
            });
        }
        
        function disconnectSerial() {
            console.log('🔌 Disconnecting...');
            addEvent('system', 'Disconnecting from Arduino...');
            
            fetch('/api/disconnect', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', 'Disconnected from Arduino');
                    // The WebSocket event will update the UI
                }
            });
        }
        
        // UI Update functions
        function updateConnectionStatus(status, port = '') {
            const statusElement = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            
            if (status === 'connected') {
                statusElement.innerHTML = '<span class="status-indicator status-connected"></span>';
                statusText.textContent = `Connected to ${port}`;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                isConnected = true;
            } else if (status === 'error') {
                statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span>';
                statusText.textContent = 'Connection Error';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                isConnected = false;
                hideCalibrationProgress();
            } else {
                statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span>';
                statusText.textContent = 'Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                isConnected = false;
                hideCalibrationProgress();
            }
        }
        
        function updateSensorStatus(status) {
            const statusElement = document.getElementById('sensor-status');
            const statusText = document.getElementById('sensor-status-text');
            
            if (status === 'calibrating') {
                statusElement.innerHTML = '<span class="status-indicator status-calibrating"></span>';
                statusText.textContent = 'Calibrating...';
                showCalibrationProgress();
            } else if (status === 'active') {
                statusElement.innerHTML = '<span class="status-indicator status-active"></span>';
                statusText.textContent = 'Armed & Active';
                hideCalibrationProgress();
                showNotification('✅ Sensor Active', 'System is armed and ready', 'success');
            } else {
                statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span>';
                statusText.textContent = 'Offline';
                hideCalibrationProgress();
            }
        }
        
        function updateMotionStatus(status, duration = null) {
            const statusElement = document.getElementById('motion-status');
            const statusText = document.getElementById('motion-status-text');
            const durationElement = document.getElementById('motion-duration');
            
            if (status === 'detected') {
                statusElement.innerHTML = '<span class="status-indicator status-motion"></span>';
                statusText.textContent = 'MOTION DETECTED!';
                statusText.style.color = '#ef4444';
                statusText.style.fontWeight = 'bold';
                durationElement.textContent = '';
            } else if (status === 'ended') {
                statusElement.innerHTML = '<span class="status-indicator status-active"></span>';
                statusText.textContent = 'No Motion';
                statusText.style.color = '';
                statusText.style.fontWeight = '';
                if (duration) {
                    durationElement.textContent = `Last duration: ${duration.toFixed(1)}s`;
                }
            } else {
                statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span>';
                statusText.textContent = 'System Offline';
                durationElement.textContent = '';
            }
        }
        
        function updateCalibrationProgress(data) {
            const progressElement = document.getElementById('calibration-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressPercent = document.getElementById('progress-percent');
            const progressRemaining = document.getElementById('progress-remaining');
            
            if (data.active) {
                progressElement.style.display = 'block';
                progressFill.style.width = `${data.progress}%`;
                progressPercent.textContent = `${Math.round(data.progress)}%`;
                progressRemaining.textContent = `${data.remaining}s remaining`;
            } else {
                hideCalibrationProgress();
            }
        }
        
        function showCalibrationProgress() {
            const progressElement = document.getElementById('calibration-progress');
            progressElement.style.display = 'block';
        }
        
        function hideCalibrationProgress() {
            const progressElement = document.getElementById('calibration-progress');
            progressElement.style.display = 'none';
        }
        
        function addEvent(type, message, duration = null) {
            const eventsLog = document.getElementById('events-log');
            const eventItem = document.createElement('div');
            eventItem.className = `event-item event-${type}`;
            
            const time = new Date().toLocaleTimeString();
            let eventHTML = `
                <div class="event-time">${time}</div>
                <div>${message}</div>
            `;
            
            if (duration) {
                eventHTML += `<div style="font-size: 0.8rem; opacity: 0.7;">Duration: ${duration.toFixed(1)}s</div>`;
            }
            
            eventItem.innerHTML = eventHTML;
            eventsLog.insertBefore(eventItem, eventsLog.firstChild);
            
            // Limit to 50 events
            if (eventsLog.children.length > 50) {
                eventsLog.removeChild(eventsLog.lastChild);
            }
        }
        
        function showNotification(title, message, type = 'danger') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            
            // Clear existing timeout
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            // Update notification content and style
            notification.className = `notification ${type === 'success' ? 'notification-success' : type === 'warning' ? 'notification-warning' : ''}`;
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // Show notification
            notification.classList.add('show');
            
            // Play sound for motion alerts
            if (type === 'danger') {
                playAlertSound();
            }
            
            // Hide after 5 seconds
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        function playAlertSound() {
            // Create a more noticeable alert sound
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                
                // Alert sound: two quick beeps
                oscillator.frequency.setValueAtTime(800, context.currentTime);
                oscillator.frequency.setValueAtTime(600, context.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, context.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(600, context.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.3, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.5);
                
                oscillator.start(context.currentTime);
                oscillator.stop(context.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('total-events').textContent = stats.total_events || 0;
                    document.getElementById('today-events').textContent = stats.today_events || 0;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                const [portsRes] = await Promise.all([
                    fetch('/api/ports')
                ]);
                
                if (portsRes.ok) {
                    const ports = await portsRes.json();
                    const portSelect = document.getElementById('port-select');
                    
                    if (ports.length > 0) {
                        portSelect.innerHTML = ports.map(port => 
                            `<option value="${port}">${port}</option>`
                        ).join('');
                        
                        // Auto-select COM10 if available
                        if (ports.includes('COM10')) {
                            portSelect.value = 'COM10';
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }
        
        // Initialize
        loadInitialData();
        
        // Auto-refresh stats every 5 seconds when connected
        setInterval(() => {
            if (isConnected) {
                updateStats();
            }
        }, 5000);
    </script>
</body>
</html>